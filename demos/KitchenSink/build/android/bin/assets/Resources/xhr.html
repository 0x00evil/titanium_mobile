<!-- <html>
 <head>
 </head>
<body style="background-color:white">
	
	<div id="button1" style="height:47px"></div>
	<div id="button2" style="height:47px"></div>
	<div id="button3" style="height:47px"></div>
	<div id="button4" style="height:47px"></div>
	
	<div id="html"></div>

	<script>
	

	// set on ready state change function
	
	var button1 = Titanium.UI.createButton({
		id:'button1',
		backgroundImage:'blue.png',
		backgroundSelectedImage:'blue_pressed.png',
		backgroundFocusedImage:'blue_focused.png',
		title:'XHR POST',
		color:'#ffffff',
		height:47,
	});
	button1.addEventListener('click',function(e)
	{
		var c = Titanium.Network.createHTTPClient();

		c.onload = function()
		{
			document.getElementById('html').innerHTML = this.responseText;
		};
		// open the client
		c.open('POST','http://api.appcelerator.net/p/v1/echo');

		// send the data
		c.send({name:'my name'});
	})


	var button2 = Titanium.UI.createButton({
		id:'button2',
		backgroundImage:'blue.png',
		backgroundSelectedImage:'blue_pressed.png',
		backgroundFocusedImage:'blue_focused.png',
		title:'XHR Charset',
		color:'#ffffff',
		height:47,
	});
	button2.addEventListener('click',function(e)
	{
		var c = Titanium.Network.createHTTPClient();

		c.onload = function()
		{
			document.getElementById('html').innerHTML = this.responseText;
		};
		// open the client
		c.open('GET','http://www.liturgiadashoras.org/Horas/1terca_laudes.htm');

		// send the data
		c.send();
	})

	var button3 = Titanium.UI.createButton({
		id:'button3',
		backgroundImage:'blue.png',
		backgroundSelectedImage:'blue_pressed.png',
		backgroundFocusedImage:'blue_focused.png',
		title:'Google',
		color:'#ffffff',
		height:47,
	});
	button3.addEventListener('click',function(e)
	{
		var c = Titanium.Network.createHTTPClient();

		c.onload = function()
		{
			document.getElementById('html').innerHTML = this.responseText;
		};
		// open the client
		c.open('GET','http://www.google.com');

		// send the data
		c.send();
	})

	var button4 = Titanium.UI.createButton({
		id:'button4',
		backgroundImage:'blue.png',
		backgroundSelectedImage:'blue_pressed.png',
		backgroundFocusedImage:'blue_focused.png',
		title:'Binary Data',
		color:'#ffffff',
		height:47,
	});
	button4.addEventListener('click',function(e)
	{
		var c = Titanium.Network.createHTTPClient();

		c.onload = function()
		{
			var f= Titanium.Filesystem.getFile("xhr.png");
			f.write(this.responseData);
		
			document.getElementById('html').innerHTML = '<img src="'+f.read().url+'"/>';
		};
		// open the client
		c.open('GET','http://www.appcelerator.com/wp-content/uploads/2009/06/titanium_desk.png');

		// send the data
		c.send();
	})
	</script>

</body>
</html> -->

<html>
<head>
	<title>eBay Local</title>
	<link href="index.css" rel="stylesheet" type="text/css">
    <script>    
        var results = [];
        var adTitle;
        
        var ad_url_map = {};
        var ad_url;
        HTTPClient.prototype.__defineGetter__('responseXML',function(){
		    return new DOMParser().parseFromString(this.getResponseText(),'text/xml');
		});
        var xhr = Titanium.Network.createHTTPClient();
        
        xhr.onreadystatechange = function() {
               if(this.readyState == 4) {


	            var responseXML = this.responseXML;
	            var xmlDoc = responseXML.documentElement;

	            // A better way to do the following is to fetch all ads first and then for an ad, get title, then url, then images

	            // fetch ad titles
	            try {
	                var titleElements = xmlDoc.getElementsByTagName("title");
	                for(var i = 0; i < titleElements.length; i++) {
	                    adTitle = titleElements[i].childNodes[0].nodeValue;
	                    results.push({title: adTitle, hasChild: true});
	                }

	            } catch(err) {
	                var a = Titanium.UI.createAlertDialog();
	                a.setTitle("Error");
	                a.setMessage("Title not found in results.");
	                a.show();
	                return;	
	            }

	            // fetch ad urls
	            try {
	                var titleElements = xmlDoc.getElementsByTagName("view_ad_url");
	                for(var i = 0; i < titleElements.length; i++) {
	                    ad_url = titleElements[i].childNodes[0].nodeValue;
	                    ad_url_map[i] = ad_url;
	                }

	            } catch(err) {
	                var a = Titanium.UI.createAlertDialog();
	                a.setTitle("Error");
	                a.setMessage("ad_url not found in results.");
	                a.show();
	                return;	
	            }

	            showTableView();

               }
        }
        
        
        function showTableView() {
            var tableView = Titanium.UI.createTableView({data:results,title:'eBay'}, function(eventObject) 
            {
				var win = Titanium.UI.createWindow({url:ad_url_map[eventObject.row],title:'View Ad'});
				win.open({animated:true});
            });
            
            //add view to current window
            Titanium.UI.currentWindow.addView(tableView);
            // show view
            Titanium.UI.currentWindow.showView(tableView);
        }
        
        xhr.open("GET", "http://apil.kijiji.com/c-ClassiApiSearchAdExCommand?xml=%3C?xml%20version=%221.0%22%20encoding=%22utf-8%22%20?%3E%3CSOAP:Envelope%20xmlns:SOAP=%22http://www.w3.org/2003/05/soap-envelope%22%3E%3CSOAP:Header%3E%3Cm:version%20xmlns:m=%22http://www.kijiji.com/soap%22%3E1%3C/m:version%3E%3C/SOAP:Header%3E%3CSOAP:Body%3E%3Cm:search_options%20xmlns:m=%22http://www.kijiji.com/soap%22%3E%3Carea_id%3E2600001%3C/area_id%3E%3Ckeyword%3E%3C/keyword%3E%3C/m:search_options%3E%3C/SOAP:Body%3E%3C/SOAP:Envelope%3E");
        xhr.send();

                


    </script>

</head>
<body>
</body>
</html>