#!/usr/bin/env python
#
# Scons script for building the iphone library
#
import os,platform

# add your module here for it to get compiled into
# the library
modules = [	'api',
			'app',
			'ui',
			'database',
			'accelerometer',
			'geolocation',
			'media',
			'filesystem',
			'network',
			'platform',
            'analytics',
			'gesture']

try:
	# pull in the version from the top-level SConstruct
	Import('version')
except:
	if ARGUMENTS.get('PRODUCT_VERSION', 0):
		version = ARGUMENTS['PRODUCT_VERSION']
	else:
		version = '0.0.0'

defines='TI_VERSION=%s ' % version

for api in modules:
	defines+="MODULE_TI_%s=1 " % (api.upper())


config = 'Release'

versions = ['3.0']
if platform.platform()!='Darwin-10.0.0b2-i386-64bit':
	versions.append('2.2.1')


for apiversion in versions:
    # execute the phone and simulator release builds
    os.system("xcodebuild -sdk iphoneos%s -project Titanium.xcodeproj -target libTitanium -configuration %s GCC_PREPROCESSOR_DEFINITIONS='%s' clean build" % (apiversion,config,defines))
    os.system("xcodebuild -sdk iphonesimulator%s -project Titanium.xcodeproj -target libTitanium -configuration %s GCC_PREPROCESSOR_DEFINITIONS='%s' clean build" % (apiversion,config,defines))

    # build the merged library using lipo
    os.system("lipo build/%s-iphonesimulator/libTitanium.a build/%s-iphoneos/libTitanium.a -create -output build/libTitanium-%s.a" %(config,config,apiversion))


